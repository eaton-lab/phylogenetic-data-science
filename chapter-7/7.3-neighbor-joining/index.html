
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../7.2-upgma/">
      
      
        <link rel="next" href="../7.4-applied/">
      
      <link rel="icon" href="/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.11">
    
    
      
        <title>7.3 - Code - Neighbor Joining - Phylogenetic Data Science (IN DEVELOPMENT)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-HV34HZZD5N"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-HV34HZZD5N",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-HV34HZZD5N",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#neighbor-joining-tree-inference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phylogenetic Data Science (IN DEVELOPMENT)" class="md-header__button md-logo" aria-label="Phylogenetic Data Science (IN DEVELOPMENT)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phylogenetic Data Science (IN DEVELOPMENT)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              7.3 - Code - Neighbor Joining
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/eaton-lab/phylogenetic-data-science" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phylogenetic Data Science (IN DEVELOPMENT)" class="md-nav__button md-logo" aria-label="Phylogenetic Data Science (IN DEVELOPMENT)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Phylogenetic Data Science (IN DEVELOPMENT)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eaton-lab/phylogenetic-data-science" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        About/Ethos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        Installation/Software
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../course/" class="md-nav__link">
        Columbia course
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          0 - Coding Bootcamp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          0 - Coding Bootcamp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/getting-started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.0-installation-conda/" class="md-nav__link">
        0.0 - Installation (conda)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.1-jupyter-and-binder/" class="md-nav__link">
        0.1 - Python Jupyter/Binder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.2-python-types/" class="md-nav__link">
        0.2 - Python types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.3-python-funcs/" class="md-nav__link">
        0.3 - Python functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.4-python-classes/" class="md-nav__link">
        0.4 - Python classes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bootcamp/0.5-python-style/" class="md-nav__link">
        0.5 - Python style
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          1 - Trees as data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          1 - Trees as data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.1-introduction/" class="md-nav__link">
        x.1 - Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.2-tree-thinking/" class="md-nav__link">
        x.2 - Tree Thinking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.3-visualization/" class="md-nav__link">
        x.3 - Visualization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.4-features-of-trees/" class="md-nav__link">
        1.4 - Tree data structure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.5-code-node-class/" class="md-nav__link">
        1.5 - Code - Node class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.6-code-tree-traversal/" class="md-nav__link">
        1.6 - Code - Tree traversal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.7-code-tree-class/" class="md-nav__link">
        1.7 - Code - Tree class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-1/1.6-exercises.md" class="md-nav__link">
        x.7 - Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          2 - Evolutionary models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          2 - Evolutionary models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.0-modeling-evolution/" class="md-nav__link">
        2.0 - Modeling evolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.1-idealized-population/" class="md-nav__link">
        2.1 - Idealized population
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.2-wright-fisher/" class="md-nav__link">
        2.2 - Wright-Fisher Process
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.3-coalescent/" class="md-nav__link">
        2.3 - The Coalescent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.4-coalescent-simulation/" class="md-nav__link">
        2.4 - Coalescent simulation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-2/2.x-exercises/" class="md-nav__link">
        2.x - Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          3 - Mutation Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          3 - Mutation Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-3/3.x-DNA-Markov.md" class="md-nav__link">
        3.0 - Modeling Evolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        3.x - Probabilistic and Generative Models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-3/3.2-markov-models/" class="md-nav__link">
        3.2 - Markov models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3.x-other-models.md" class="md-nav__link">
        3.x - Other models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1-reading-list.md" class="md-nav__link">
        Reading and Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          4 - Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          4 - Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.1-data-formats.md" class="md-nav__link">
        x.1 - data formats
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.2-strings-and-matrices.md" class="md-nav__link">
        x.2 - strings, tables, and matrices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../x.x-simulating-traits.md" class="md-nav__link">
        x.x - Code - simulating data/traits
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../x.x-sequence-alignment.md" class="md-nav__link">
        x.x - Code - sequence alignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../x.x-converting-file-formats.md" class="md-nav__link">
        x.x - Code - converting file formats
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../read, write, parse, find, and clean phylip, fasta, fastq, and vcf data." class="md-nav__link">
        Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          5 - Phylogenetic Inference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          5 - Phylogenetic Inference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.0 - introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.1 - history
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.2 - choosing a method
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../x.3 - ..." class="md-nav__link">
        None
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../x.4 - ..." class="md-nav__link">
        None
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          6 - Inference (Parsimony)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          6 - Inference (Parsimony)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-6/6.0-fitch-parsimony/" class="md-nav__link">
        6.0 - Fitch Parsimony
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-6/6.1-fitch-multiple-traits/" class="md-nav__link">
        6.1 - Character matrices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        6.2 - Sankoff Parsimony
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          7 - Inference (Distance-based)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          7 - Inference (Distance-based)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.0-introduction/" class="md-nav__link">
        7.0 - Distance based trees
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.1-least-squares/" class="md-nav__link">
        7.1 - Code - Least-squares
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.2-upgma/" class="md-nav__link">
        7.2 - Code - UPGMA
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          7.3 - Code - Neighbor Joining
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        7.3 - Code - Neighbor Joining
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-data" class="md-nav__link">
    Example Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-analysis" class="md-nav__link">
    Example Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#algorithm" class="md-nav__link">
    Algorithm
  </a>
  
    <nav class="md-nav" aria-label="Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-get-average-distances" class="md-nav__link">
    1: get average distances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-find-smallest-distance" class="md-nav__link">
    2: find smallest distance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-get-branch-lengths" class="md-nav__link">
    3: get branch lengths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-update-matrix-distances" class="md-nav__link">
    4: update matrix distances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-repeat-if-2-samples-remain" class="md-nav__link">
    5: repeat if &gt;2 samples remain
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    NEXT...
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.4-applied/" class="md-nav__link">
        7.4 - Applied examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.5-new-applications/" class="md-nav__link">
        7.5 - New Applications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          8 - Inference (Likelihood)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          8 - Inference (Likelihood)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.0 - Maximum Likelihood
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.1 - Genealogies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.2 - Sequences
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        x.3 - Inferring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Reading and Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          9 - Multispecies Coalescent
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          9 - Multispecies Coalescent
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-9/9.0-intro.md" class="md-nav__link">
        9.0 - Species trees
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-9/9.1-likelihood.md" class="md-nav__link">
        9.1 - Coalescent likelihood
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-9/9.2-genealogical.md" class="md-nav__link">
        9.2 - Genealogical thinking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-9/9.2-genetics.md" class="md-nav__link">
        9.3 - Genetic thinking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter-9/9.3-MSC.md" class="md-nav__link">
        9.4 - MSC likelihood
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Reading and Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-data" class="md-nav__link">
    Example Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-analysis" class="md-nav__link">
    Example Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#algorithm" class="md-nav__link">
    Algorithm
  </a>
  
    <nav class="md-nav" aria-label="Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-get-average-distances" class="md-nav__link">
    1: get average distances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-find-smallest-distance" class="md-nav__link">
    2: find smallest distance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-get-branch-lengths" class="md-nav__link">
    3: get branch lengths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-update-matrix-distances" class="md-nav__link">
    4: update matrix distances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-repeat-if-2-samples-remain" class="md-nav__link">
    5: repeat if &gt;2 samples remain
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    NEXT...
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="neighbor-joining-tree-inference">Neighbor-Joining Tree Inference<a class="headerlink" href="#neighbor-joining-tree-inference" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Neighbor-joining (NJ) is an algorithm for inferring trees from distance
data, first described by Saitou and Nei (1987). In contrast to UPGMA it 
does not assume a clock, and is therefore is less likely to infer the 
wrong tree due to rate variation. In fact, the NJ method is guaranteed to 
recover the true tree if the distance matrix is an exact reflection of 
distances on the true tree. </p>
<p>For very large data sets, even when employing bootstrapping to re-sample
a data matrix and infer multiple trees, the greedy algorithmic approach to
building using clustering results in only a very tiny proportion of tree 
space being explored.</p>
<h2 id="example-data">Example Data<a class="headerlink" href="#example-data" title="Permanent link">&para;</a></h2>
<p>To demonstrate the neighbor-joining algorithm we will re-use the same 
dataset as in the previous lessons, which is a distance matrix from 
Sarich (1969), and which was similarly used as an example in Felsenstein
(2004). </p>
<div class="highlight"><pre><span></span><code><span class="n">NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dog&quot;</span><span class="p">,</span> <span class="s2">&quot;bear&quot;</span><span class="p">,</span> <span class="s2">&quot;raccoon&quot;</span><span class="p">,</span> <span class="s2">&quot;weasel&quot;</span><span class="p">,</span> <span class="s2">&quot;seal&quot;</span><span class="p">,</span> <span class="s2">&quot;sea lion&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="s2">&quot;monkey&quot;</span><span class="p">]</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">NAMES</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">NAMES</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">148</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">136</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">152</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">51</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">142</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">142</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">142</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">148</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">148</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">])</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="example-analysis">Example Analysis<a class="headerlink" href="#example-analysis" title="Permanent link">&para;</a></h2>
<p>The code that we will develop below to implement a neighbor-joining tree
inference algorithm is available in the <code>toytree.infer</code> subpackage:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># infer an NJ tree from a distance matrix and plot it.</span>
<span class="n">TREE</span> <span class="o">=</span> <span class="n">toytree</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">neighbor_joining</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
<span class="n">TREE</span><span class="o">.</span><span class="n">draw</span><span class="p">();</span>
</code></pre></div>
<p><mark>TODO: insert tree drawing here.</mark></p>
<h2 id="algorithm">Algorithm<a class="headerlink" href="#algorithm" title="Permanent link">&para;</a></h2>
<p>An algorithm for neighbor-joining is described by Studier and Keppler 1988,
starting from a distance matrix for N samples, where the distance between
sample <span class="arithmatex">\(i\)</span> and <span class="arithmatex">\(j\)</span> is <span class="arithmatex">\(D_{ij}\)</span>. Below this algorithm is described both 
verbally, as well as in mathematical notation, and with Python code. To 
demonstrate how to translate these equations <em>into code</em>, we will start
first with how to interpret them, followed by writing psuedo-code to 
convert logic into Python, and finally, we will write a full Python
neighbor-joining algorithm.</p>
<h3 id="1-get-average-distances">1: get average distances<a class="headerlink" href="#1-get-average-distances" title="Permanent link">&para;</a></h3>
<p>Compute the average distance (<span class="arithmatex">\(u_i\)</span>) from each sample in the distance
matrix to the others (excluding a comparison of a sample to itself):</p>
<div class="arithmatex">\[ u_i = \sum\limits_{j:j{\neq}i}^{n} \frac{D_{ij}}{(n-2)} \]</div>
<p>The stated goal of this step is to compute a value for each sample, so 
we know to expect the output to be a list or 1-D array of values. To 
compute this for each sample at a time we could perform a for-loop that
will visit each sample. So let's begin first by just writing the very first 
step of this algorithm, a for-loop to iterate over each sample. This could
be done with indexing, or, in this case where we have a DataFrame object,
we can simply iterate over the <code>.index</code> attribute (row names).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># iterate over each sample in the data</span>
<span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="c1"># ... do whatever comes next.</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sample_i</span><span class="p">)</span>
</code></pre></div>
<p>Next, we see a summation symbol (<span class="arithmatex">\(\sum\limits_{j:j{\neq}i}^{n}\)</span>). Based
on the lower and upper bounds of the summation, this can be interpreted
to mean that we will sum <em>something</em> for each item <span class="arithmatex">\(j\)</span> from a collection
of items that ranges from <span class="arithmatex">\(j\)</span> to <span class="arithmatex">\(n\)</span>. In <em>code-think</em>, this sounds like 
another for-loop, iterating over the samples once again, but now referring
to their index as <span class="arithmatex">\(j\)</span>. It also says <span class="arithmatex">\({j:j{\neq}i}\)</span>, which means that we 
should skip any iteration where the <span class="arithmatex">\(j\)</span> is the same as <span class="arithmatex">\(i\)</span>. In other words,
skip the iterations where a sample is compared to itself. 
Here's what we have now:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># iterate over each sample in the data</span>
<span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sample_j</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sample_i</span> <span class="o">!=</span> <span class="n">sample_j</span><span class="p">:</span>
            <span class="c1"># ... do whatever comes next.</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sample_i</span><span class="p">,</span> <span class="n">sample_j</span><span class="p">)</span>
</code></pre></div>
<p>Finally, we are to the part of the equation that defines the measurement
that awe are summing over: <span class="arithmatex">\(\frac{D_{ij}}{(n-2)}\)</span>. At this point in the code,
we have both <span class="arithmatex">\(i\)</span> and <span class="arithmatex">\(j\)</span>, which we can use to index a value from the 
matrix <span class="arithmatex">\(D\)</span>. And we know that <span class="arithmatex">\(n\)</span> is the number of samples, which is the same
as the number of columns in the matrix. So let's calculate the <span class="arithmatex">\(u_i\)</span> now
by putting this all together. Here I use a dictionary to store values that
will be summed during the iteration.</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># a dict to store u_i values</span>
<span class="n">u_values</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># get number of samples</span>
<span class="n">nsamples</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># iterate over samples</span>
<span class="k">for</span> <span class="n">sample_i</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="c1"># start u_i value at 0</span>
    <span class="n">u_values</span><span class="p">[</span><span class="n">sample_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">sample_j</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sample_i</span> <span class="o">!=</span> <span class="n">sample_j</span><span class="p">:</span>
            <span class="c1"># add this value to summed u_i</span>
            <span class="n">u_values</span><span class="p">[</span><span class="n">sample_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_i</span><span class="p">,</span> <span class="n">sample_j</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">nsamples</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">u_values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># {&#39;dog&#39;: 79.16666666666667,</span>
<span class="c1">#  &#39;bear&#39;: 62.33333333333333,</span>
<span class="c1">#  &#39;raccoon&#39;: 74.66666666666667,</span>
<span class="c1">#  &#39;weasel&#39;: 72.83333333333334,</span>
<span class="c1">#  &#39;seal&#39;: 70.33333333333333,</span>
<span class="c1">#  &#39;sea lion&#39;: 69.83333333333333,</span>
<span class="c1">#  &#39;cat&#39;: 114.5,</span>
<span class="c1">#  &#39;monkey&#39;: 168.33333333333334}</span>
</code></pre></div></p>
<p>The example above was written to be easy to read and understand. But, 
we can actually compute the same result much faster, and more concisely,
using broadcasting with <code>numpy</code> arrays (or with <code>pandas</code>). 
For example, we can compute the sum of distance values across each row of 
the distance matrix by calling <code>.sum(axis=0)</code>, and then divide all of the 
row sums by the same constant to get the result as an array. We will use 
this notation in our final function.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">uvals</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">uvals</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># array([ 79.16666667,  62.33333333,  74.66666667,  72.83333333,</span>
<span class="c1">#         70.33333333,  69.83333333, 114.5       , 168.33333333])</span>
</code></pre></div></p>
<h3 id="2-find-smallest-distance">2: find smallest distance<a class="headerlink" href="#2-find-smallest-distance" title="Permanent link">&para;</a></h3>
<p>We now have our 2-D distance matrix <span class="arithmatex">\(D_{ij}\)</span>, and a 1-D array of 
<span class="arithmatex">\(u_{i}\)</span> values. In step 2, we need to find the smallest value of
<span class="arithmatex">\(D_{ij} - u_i - j_i\)</span>, which represents a modified distance
that is corrected for neighbor-ness. The indices of the smallest
values will represent the two samples that will be clustered 
in this iteration of the algorithm. </p>
<p>In the code below I subtract the <span class="arithmatex">\(u_i\)</span> values (<code>uvals</code>) from each column of 
the distance matrix (<code>arr</code>) using numpy broadcasting, and also subtract
<code>uvals</code> from each row of <code>arr</code> with broadcasting by first expanding the 
dimension of <code>uvals</code> so that its shape is <code>(n, 1)</code>. This is a 
simple trick in numpy to broadcast row-wise versus column-wise. The new
distance values are stored as <code>c_arr</code>. The following code block creates
a mask to select only the values not on the diagonal, and then finds the
index of the minimum value.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># subtract neighbor distances column-wise and row-wise from D</span>
<span class="n">c_arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">uvals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># find index of min value not on the matrix diagonal</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">c_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">idxs</span><span class="p">,</span> <span class="n">jdxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c_arr</span> <span class="o">==</span> <span class="n">c_arr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

<span class="c1"># get first index value in case there is a tie</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">jdxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>To further demonstrate, you can see below what <code>uvals</code> looks like before 
and after adding a dimension, and how it is subtracted from each column
or row of the distance array. (To make these arrays easier to read by 
showing only two floating point values I called 
<code>np.set_printoptions(precision=2)</code>).</p>
<p>The values in the 2-D distance array <code>arr</code>:
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [[  0  32  48  51  50  48  98 148]</span>
<span class="c1">#  [ 32   0  26  34  29  33  84 136]</span>
<span class="c1">#  [ 48  26   0  42  44  44  92 152]</span>
<span class="c1">#  [ 51  34  42   0  44  38  86 142]</span>
<span class="c1">#  [ 50  29  44  44   0  24  89 142]</span>
<span class="c1">#  [ 48  33  44  38  24   0  90 142]</span>
<span class="c1">#  [ 98  84  92  86  89  90   0 148]</span>
<span class="c1">#  [148 136 152 142 142 142 148   0]]</span>
</code></pre></div></p>
<p>Subtract the <span class="arithmatex">\(i^{th}\)</span> <span class="arithmatex">\(u_i\)</span> value from all items in the <span class="arithmatex">\(i^{th}\)</span> <strong>column</strong> of <code>arr</code>:
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">uvals</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [ 79.17  62.33  74.67  72.83  70.33  69.83 114.5  168.33]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># subtract column-wise</span>
<span class="nb">print</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">uvals</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [[ -79.17  -30.33  -26.67  -21.83  -20.33  -21.83  -16.5   -20.33]</span>
<span class="c1">#  [ -47.17  -62.33  -48.67  -38.83  -41.33  -36.83  -30.5   -32.33]</span>
<span class="c1">#  [ -31.17  -36.33  -74.67  -30.83  -26.33  -25.83  -22.5   -16.33]</span>
<span class="c1">#  [ -28.17  -28.33  -32.67  -72.83  -26.33  -31.83  -28.5   -26.33]</span>
<span class="c1">#  [ -29.17  -33.33  -30.67  -28.83  -70.33  -45.83  -25.5   -26.33]</span>
<span class="c1">#  [ -31.17  -29.33  -30.67  -34.83  -46.33  -69.83  -24.5   -26.33]</span>
<span class="c1">#  [  18.83   21.67   17.33   13.17   18.67   20.17 -114.5   -20.33]</span>
<span class="c1">#  [  68.83   73.67   77.33   69.17   71.67   72.17   33.5  -168.33]]</span>
</code></pre></div></p>
<p>Alternatively, subtract the <span class="arithmatex">\(i^{th}\)</span> <span class="arithmatex">\(u_i\)</span> value from all items in the 
<span class="arithmatex">\(i^{th}\)</span> <strong>row</strong> of <code>arr</code>.
<div class="highlight"><pre><span></span><code><span class="c1"># reshape to (n,1) to align row-wise with arr</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [[ 79.17]</span>
<span class="c1">#  [ 62.33]</span>
<span class="c1">#  [ 74.67]</span>
<span class="c1">#  [ 72.83]</span>
<span class="c1">#  [ 70.33]</span>
<span class="c1">#  [ 69.83]</span>
<span class="c1">#  [114.5 ]</span>
<span class="c1">#  [168.33]]</span>
</code></pre></div></p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># subtract row-wise</span>
<span class="nb">print</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [[ -79.17  -47.17  -31.17  -28.17  -29.17  -31.17   18.83   68.83]</span>
<span class="c1">#  [ -30.33  -62.33  -36.33  -28.33  -33.33  -29.33   21.67   73.67]</span>
<span class="c1">#  [ -26.67  -48.67  -74.67  -32.67  -30.67  -30.67   17.33   77.33]</span>
<span class="c1">#  [ -21.83  -38.83  -30.83  -72.83  -28.83  -34.83   13.17   69.17]</span>
<span class="c1">#  [ -20.33  -41.33  -26.33  -26.33  -70.33  -46.33   18.67   71.67]</span>
<span class="c1">#  [ -21.83  -36.83  -25.83  -31.83  -45.83  -69.83   20.17   72.17]</span>
<span class="c1">#  [ -16.5   -30.5   -22.5   -28.5   -25.5   -24.5  -114.5    33.5 ]</span>
<span class="c1">#  [ -20.33  -32.33  -16.33  -26.33  -26.33  -26.33  -20.33 -168.33]]</span>
</code></pre></div></p>
<p>The final result was to perform both subtractions on the distance
matrix and then to find the index of the lowest off-diagonal value.
In the matrix below the lowest value is -134.83, at index <code>(6, 7)</code>, 
or <code>(7, 6)</code>, depending on which side of the matrix is searched first.</p>
<p><div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">uvals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># [[-158.33 -109.5  -105.83 -101.    -99.5  -101.    -95.67  -99.5 ]</span>
<span class="c1">#  [-109.5  -124.67 -111.   -101.17 -103.67  -99.17  -92.83  -94.67]</span>
<span class="c1">#  [-105.83 -111.   -149.33 -105.5  -101.   -100.5   -97.17  -91.  ]</span>
<span class="c1">#  [-101.   -101.17 -105.5  -145.67  -99.17 -104.67 -101.33  -99.17]</span>
<span class="c1">#  [ -99.5  -103.67 -101.    -99.17 -140.67 -116.17  -95.83  -96.67]</span>
<span class="c1">#  [-101.    -99.17 -100.5  -104.67 -116.17 -139.67  -94.33  -96.17]</span>
<span class="c1">#  [ -95.67  -92.83  -97.17 -101.33  -95.83  -94.33 -229.   -134.83]</span>
<span class="c1">#  [ -99.5   -94.67  -91.    -99.17  -96.67  -96.17 -134.83 -336.67]]</span>
</code></pre></div></p>
<h3 id="3-get-branch-lengths">3: get branch lengths<a class="headerlink" href="#3-get-branch-lengths" title="Permanent link">&para;</a></h3>
<p>Given that we just found the <span class="arithmatex">\(i\)</span> and <span class="arithmatex">\(j\)</span> indices above, the code to calculate
the branch lengths of these Nodes to their internal Node parent 
is very simple:</p>
<div class="arithmatex">\[ 
v_i = \frac{1}{2}D_{ij} + \frac{1}{2}(u_i - u_j) 
\]</div>
<div class="arithmatex">\[
v_j = \frac{1}{2}D_{ij} + \frac{1}{2}(u_j - u_i) 
\]</div>
<div class="highlight"><pre><span></span><code><span class="c1"># get branch lengths for Nodes i and j</span>
<span class="n">v_i</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">uvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">uvals</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="n">v_j</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">uvals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">uvals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>
<p>This information could be used right away to begin to construct a tree, 
for example by creating <code>toytree.Node</code> instances and connecting them; or,
this information could be stored until the end, after all iterations of 
the algorithm are finished, and the final tree constructed then. Either
way, the information that exists at this point in the algorithm, during
our first iteration, is that two Nodes have now been joined, and the
other tips remain not yet joined. Before we can proceed to the next 
iteration, we need to update the distance matrix to remove the two tip 
Nodes that are not longer relevant, and to replace them with their new
parent Node, and its distances to the other Nodes.</p>
<p><mark>TODO: insert drawing here...</mark></p>
<h3 id="4-update-matrix-distances">4: update matrix distances<a class="headerlink" href="#4-update-matrix-distances" title="Permanent link">&para;</a></h3>
<p>We now need to update the distance matrix so that ...</p>
<div class="highlight"><pre><span></span><code><span class="c1"># get dimension of the new matrix and make a new empty array</span>
<span class="n">new_dim</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">new_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">new_dim</span><span class="p">,</span> <span class="n">new_dim</span><span class="p">))</span>

<span class="c1"># create a boolean mask of old matrix size, with False at i and j.</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># fill new matrix with dists from old matrix for non-i,j samples</span>
<span class="n">new_arr</span><span class="p">[:</span><span class="n">new_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:</span><span class="n">new_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">mask</span><span class="p">]</span>

<span class="c1"># get distances from each remaining sample to the new ancestor of i,j</span>
<span class="n">new_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>

<span class="c1"># replace arr with the new arr</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">new_arr</span>
</code></pre></div>
<h3 id="5-repeat-if-2-samples-remain">5: repeat if &gt;2 samples remain<a class="headerlink" href="#5-repeat-if-2-samples-remain" title="Permanent link">&para;</a></h3>
<h2 id="next">NEXT...<a class="headerlink" href="#next" title="Permanent link">&para;</a></h2>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "search.highlight", "search.suggest", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6df46069.min.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>